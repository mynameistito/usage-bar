name: Release

on:
  push:
    branches: [main]

# Only one release job runs at a time per branch.
concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write       # push tags, create releases
      pull-requests: write  # create / update the version PR
    env:
      LEFTHOOK: 0           # disable git hooks in CI (pre-commit runs cargo:precheck which needs Linux GTK libs)

    steps:
      - uses: actions/checkout@v4
        with:
          # Full history is required so changeset can diff against the base.
          fetch-depth: 0
          # Use the default GITHUB_TOKEN; commits made by the action will
          # not re-trigger CI (expected behaviour for version bump commits).
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # When changeset files are present on main the action opens (or updates)
      # a "Version Packages" PR.  When that PR is merged the changeset files
      # are gone and `hasChangesets` becomes false — that is the signal to cut
      # a release in the next step.
      - name: Create version PR
        id: changesets
        uses: changesets/action@v1
        with:
          version: bun run version
          title: "chore: version packages"
          commit: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Runs only after the version PR is merged (no more pending changesets).
      # The script is idempotent — it exits cleanly if the tag already exists.
      - name: Tag and create GitHub release
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: bun run release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
